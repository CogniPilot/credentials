name: Revoke Credential

on:
  issues:
    types: [labeled]

jobs:
  revoke-credential:
    if: github.event.label.name == 'approve-revocation'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      actions: write

    steps:
      - name: Check write permission
        id: check-permission
        uses: actions/github-script@v7
        with:
          script: |
            const username = context.actor;

            try {
              const { data: permissionLevel } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: username
              });

              const permission = permissionLevel.permission;
              console.log(`${username} has ${permission} permission`);

              if (permission === 'admin' || permission === 'write') {
                console.log(`${username} is authorized to approve revocations`);
                return true;
              }
            } catch (error) {
              console.log(`Error checking permissions: ${error.message}`);
            }

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'approve-revocation'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@${username} You do not have permission to approve revocations. Only repository collaborators with write access can approve revocation requests.`
            });

            core.setFailed(`${username} is not authorized to approve revocations`);
            return false;

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pynacl base58

      - name: Parse issue
        id: parse-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            const issueAuthor = context.payload.issue.user.login;
            const issueNumber = context.payload.issue.number;

            const parseField = (body, fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };

            const email = parseField(issueBody, 'Credential Holder Email');
            const achievementId = parseField(issueBody, 'Achievement ID');
            const reason = parseField(issueBody, 'Reason for Revocation');

            if (!email || !achievementId) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `Failed to parse issue form. Email and Achievement ID are required.\n\nParsed values:\n- Email: ${email || '(missing)'}\n- Achievement ID: ${achievementId || '(missing)'}`
              });
              core.setFailed('Email and Achievement ID are required');
              return;
            }

            core.setOutput('email', email);
            core.setOutput('achievement_id', achievementId);
            core.setOutput('reason', reason);
            core.setOutput('issue_author', issueAuthor);
            core.setOutput('issue_number', issueNumber);

            console.log(`Email: ${email}`);
            console.log(`Achievement ID: ${achievementId}`);
            console.log(`Reason: ${reason}`);

      - name: Revoke credential
        id: revoke
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          # Write signing key to file
          echo "$SIGNING_KEY" > keys/key-1-private.json
          chmod 600 keys/key-1-private.json

          cd scripts
          python revoke_credential.py \
            --email "${{ steps.parse-issue.outputs.email }}" \
            --achievement "${{ steps.parse-issue.outputs.achievement_id }}" \
            --key ../keys/key-1-private.json

          echo "revoked=true" >> $GITHUB_OUTPUT

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          git commit -m "Revoke credential: ${{ steps.parse-issue.outputs.email }} - ${{ steps.parse-issue.outputs.achievement_id }}

          Reason: ${{ steps.parse-issue.outputs.reason }}
          Requested in #${{ steps.parse-issue.outputs.issue_number }}"

          git push

      - name: Trigger deploy workflow
        run: gh workflow run deploy.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on issue and close
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.parse-issue.outputs.issue_number }};
            const issueAuthor = '${{ steps.parse-issue.outputs.issue_author }}';
            const email = '${{ steps.parse-issue.outputs.email }}';
            const achievementId = '${{ steps.parse-issue.outputs.achievement_id }}';

            const comment = `@${issueAuthor} The credential has been revoked.

            **Revocation Details:**
            - **Email:** ${email}
            - **Achievement:** ${achievementId}

            The credential will now fail verification. This change will be live shortly after the site deploys.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });
