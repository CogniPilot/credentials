name: Update Credential Details

on:
  issues:
    types: [labeled]

jobs:
  update-credential:
    if: github.event.label.name == 'approve-update'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Check team membership
        id: check-team
        uses: actions/github-script@v7
        with:
          script: |
            const org = 'CogniPilot';
            const team_slug = 'credentials';
            const username = context.actor;

            try {
              const members = await github.rest.teams.listMembersInOrg({
                org: org,
                team_slug: team_slug,
                per_page: 100
              });

              const isMember = members.data.some(member => member.login === username);

              if (isMember) {
                console.log(`${username} is a member of ${org}/${team_slug}`);
                return true;
              }
            } catch (error) {
              console.log(`Error checking team membership: ${error.message}`);
            }

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'approve-update'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@${username} You do not have permission to approve updates. Only members of the @CogniPilot/credentials team can approve update requests.`
            });

            core.setFailed(`${username} is not authorized to approve updates`);
            return false;

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue
        id: parse-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            const issueAuthor = context.payload.issue.user.login;
            const issueNumber = context.payload.issue.number;

            const parseField = (body, fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };

            const currentEmail = parseField(issueBody, 'Current Email');
            const newEmail = parseField(issueBody, 'New Email \\(Optional\\)');
            const newSlug = parseField(issueBody, 'New Profile Slug \\(Optional\\)');

            if (!currentEmail) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `Failed to parse issue form. Current Email is required.`
              });
              core.setFailed('Current Email is required');
              return;
            }

            // Filter out _No response_ placeholder
            const cleanNewEmail = newEmail === '_No response_' ? '' : newEmail;
            const cleanNewSlug = newSlug === '_No response_' ? '' : newSlug;

            if (!cleanNewEmail && !cleanNewSlug) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `No changes requested. Please provide either a new email or a new profile slug.`
              });
              core.setFailed('No changes requested');
              return;
            }

            core.setOutput('current_email', currentEmail);
            core.setOutput('new_email', cleanNewEmail);
            core.setOutput('new_slug', cleanNewSlug);
            core.setOutput('issue_author', issueAuthor);
            core.setOutput('issue_number', issueNumber);

            console.log(`Current email: ${currentEmail}`);
            console.log(`New email: ${cleanNewEmail || '(no change)'}`);
            console.log(`New slug: ${cleanNewSlug || '(no change)'}`);

      - name: Update credential details
        id: update
        run: |
          set -e

          CURRENT_EMAIL="${{ steps.parse-issue.outputs.current_email }}"
          NEW_EMAIL="${{ steps.parse-issue.outputs.new_email }}"
          NEW_SLUG="${{ steps.parse-issue.outputs.new_slug }}"

          # Load wallet registry
          if [ ! -f wallet-registry.json ]; then
            echo "Wallet registry not found"
            exit 1
          fi

          # Find current slug from email
          CURRENT_SLUG=$(jq -r --arg email "$CURRENT_EMAIL" '.email_index[$email] // empty' wallet-registry.json)

          if [ -z "$CURRENT_SLUG" ]; then
            echo "Email not found in registry: $CURRENT_EMAIL"
            exit 1
          fi

          echo "Found profile: $CURRENT_SLUG"
          echo "current_slug=$CURRENT_SLUG" >> $GITHUB_OUTPUT

          # Determine final slug
          if [ -n "$NEW_SLUG" ]; then
            FINAL_SLUG="$NEW_SLUG"
          else
            FINAL_SLUG="$CURRENT_SLUG"
          fi
          echo "final_slug=$FINAL_SLUG" >> $GITHUB_OUTPUT

          # Update email in registry if changed
          if [ -n "$NEW_EMAIL" ]; then
            echo "Updating email from $CURRENT_EMAIL to $NEW_EMAIL"

            # Remove old email from index
            jq --arg old_email "$CURRENT_EMAIL" 'del(.email_index[$old_email])' wallet-registry.json > tmp.json
            mv tmp.json wallet-registry.json

            # Update wallet emails array
            jq --arg slug "$CURRENT_SLUG" --arg old_email "$CURRENT_EMAIL" --arg new_email "$NEW_EMAIL" \
              '.wallets[$slug].emails = (.wallets[$slug].emails | map(if . == $old_email then $new_email else . end))' \
              wallet-registry.json > tmp.json
            mv tmp.json wallet-registry.json

            # Add new email to index (will use final slug)
            jq --arg new_email "$NEW_EMAIL" --arg slug "$FINAL_SLUG" \
              '.email_index[$new_email] = $slug' wallet-registry.json > tmp.json
            mv tmp.json wallet-registry.json

            # Update request files
            for req_file in requests/*.json; do
              if [ -f "$req_file" ]; then
                if jq -e --arg email "$CURRENT_EMAIL" '.recipient_email == $email' "$req_file" > /dev/null 2>&1; then
                  jq --arg new_email "$NEW_EMAIL" '.recipient_email = $new_email' "$req_file" > tmp.json
                  mv tmp.json "$req_file"
                  echo "Updated email in $req_file"
                fi
              fi
            done
          fi

          # Rename profile directory if slug changed
          if [ -n "$NEW_SLUG" ] && [ "$NEW_SLUG" != "$CURRENT_SLUG" ]; then
            echo "Renaming profile from $CURRENT_SLUG to $NEW_SLUG"

            if [ -d "docs/profile/$CURRENT_SLUG" ]; then
              mv "docs/profile/$CURRENT_SLUG" "docs/profile/$NEW_SLUG"
              echo "Renamed directory"

              # Update wallet registry with new slug
              jq --arg old_slug "$CURRENT_SLUG" --arg new_slug "$NEW_SLUG" \
                '.wallets[$new_slug] = .wallets[$old_slug] | del(.wallets[$old_slug])' \
                wallet-registry.json > tmp.json
              mv tmp.json wallet-registry.json

              # Update email index to point to new slug
              for email in $(jq -r --arg slug "$CURRENT_SLUG" '.email_index | to_entries[] | select(.value == $slug) | .key' wallet-registry.json); do
                jq --arg email "$email" --arg new_slug "$NEW_SLUG" \
                  '.email_index[$email] = $new_slug' wallet-registry.json > tmp.json
                mv tmp.json wallet-registry.json
              done

              # Also update any emails added in this run
              if [ -n "$NEW_EMAIL" ]; then
                jq --arg new_email "$NEW_EMAIL" --arg new_slug "$NEW_SLUG" \
                  '.email_index[$new_email] = $new_slug' wallet-registry.json > tmp.json
                mv tmp.json wallet-registry.json
              fi

              # Update request files with new slug
              for req_file in requests/*.json; do
                if [ -f "$req_file" ]; then
                  if jq -e --arg slug "$CURRENT_SLUG" '.wallet_slug == $slug' "$req_file" > /dev/null 2>&1; then
                    jq --arg new_slug "$NEW_SLUG" '.wallet_slug = $new_slug' "$req_file" > tmp.json
                    mv tmp.json "$req_file"

                    # Update URLs in request file
                    jq --arg old_slug "$CURRENT_SLUG" --arg new_slug "$NEW_SLUG" \
                      '.credential_url = (.credential_url | gsub($old_slug; $new_slug)) |
                       .wallet_url = (.wallet_url | gsub($old_slug; $new_slug)) |
                       .linkedin_url = (.linkedin_url | gsub($old_slug; $new_slug))' \
                      "$req_file" > tmp.json
                    mv tmp.json "$req_file"
                    echo "Updated slug in $req_file"
                  fi
                fi
              done

              # Update HTML files in the profile directory
              for html_file in docs/profile/$NEW_SLUG/*/index.html docs/profile/$NEW_SLUG/wallet/index.html; do
                if [ -f "$html_file" ]; then
                  sed -i "s|/profile/$CURRENT_SLUG/|/profile/$NEW_SLUG/|g" "$html_file"
                  echo "Updated URLs in $html_file"
                fi
              done
            fi
          fi

          echo "Update complete"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git diff --staged --quiet && echo "No changes to commit" && exit 0

          CURRENT_SLUG="${{ steps.update.outputs.current_slug }}"
          FINAL_SLUG="${{ steps.update.outputs.final_slug }}"
          NEW_EMAIL="${{ steps.parse-issue.outputs.new_email }}"

          COMMIT_MSG="Update credential: $CURRENT_SLUG"
          if [ -n "$NEW_EMAIL" ]; then
            COMMIT_MSG="$COMMIT_MSG -> email: $NEW_EMAIL"
          fi
          if [ "$FINAL_SLUG" != "$CURRENT_SLUG" ]; then
            COMMIT_MSG="$COMMIT_MSG -> slug: $FINAL_SLUG"
          fi

          git commit -m "$COMMIT_MSG

          Requested in #${{ steps.parse-issue.outputs.issue_number }}"

          git push

      - name: Comment on issue and close
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.parse-issue.outputs.issue_number }};
            const issueAuthor = '${{ steps.parse-issue.outputs.issue_author }}';
            const currentSlug = '${{ steps.update.outputs.current_slug }}';
            const finalSlug = '${{ steps.update.outputs.final_slug }}';
            const newEmail = '${{ steps.parse-issue.outputs.new_email }}';

            let changes = [];
            if (newEmail) {
              changes.push(`- Email updated to: ${newEmail}`);
            }
            if (finalSlug !== currentSlug) {
              changes.push(`- Profile URL changed to: https://credentials.cognipilot.org/profile/${finalSlug}/wallet`);
            }

            const comment = `@${issueAuthor} Your credential details have been updated!

            **Changes made:**
            ${changes.join('\n')}

            The changes will be live shortly after the site deploys.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });
